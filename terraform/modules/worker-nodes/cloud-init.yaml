#cloud-config

# Update and install required packages
package_update: true
package_upgrade: true
packages:
  - curl
  - wget
  - ca-certificates
  - gnupg
  - lsb-release
  - apt-transport-https
  - software-properties-common
  - open-iscsi  # Required for CSI
  - nfs-common  # Useful for NFS storage

# Install K3s agent
runcmd:
  # Wait for network to be fully ready
  - sleep 10

  # Set hostname
  - hostnamectl set-hostname ${hostname}

  # Detect private network interface and write K3s config
  - |
    PRIVATE_IFACE=$(ip -o addr show | grep "${private_ip}" | awk '{print $2}')
    mkdir -p /etc/rancher/k3s
    cat > /etc/rancher/k3s/config.yaml <<EOF
    server: https://${server_ip}:6443
    token: ${k3s_token}
    node-ip: ${private_ip}
    flannel-iface: $PRIVATE_IFACE
    kubelet-arg:
      - "cloud-provider=external"
    EOF

  # Install K3s agent
  - |
    curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION="${k3s_version}" INSTALL_K3S_EXEC="agent" sh -

  # Wait for node to join cluster
  - |
    for i in {1..60}; do
      if systemctl is-active --quiet k3s-agent; then
        echo "K3s agent is running"
        break
      fi
      echo "Waiting for K3s agent to start... ($i/60)"
      sleep 5
    done

# Optimize system settings for Kubernetes
bootcmd:
  - echo "net.bridge.bridge-nf-call-iptables=1" >> /etc/sysctl.conf
  - echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
  - echo "net.bridge.bridge-nf-call-ip6tables=1" >> /etc/sysctl.conf
  - sysctl -p